{% extends 'base.html' %}
{% block body %}
<style>
.product-card {
  background: #f5f5f5;
  border-radius: 12px;
  overflow: hidden;
  transition: transform 0.2s ease;
  display: flex;
  flex-direction: column;
  min-height: 100%;
}

.product-card:hover {
  transform: translateY(-3px);
}

.product-image-wrapper {
  position: relative;
  padding: 0.75rem 0.75rem 0.15rem;
  background: #f5f5f5;
  aspect-ratio: 3/4;
  display: flex;
  align-items: center;
  justify-content: center;
}

.product-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 10px;
}

.favorite-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 38px;
  height: 38px;
  border-radius: 50%;
  border: none;
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background 0.2s ease, transform 0.2s ease;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

.favorite-btn:hover {
  background: #ff6b6b;
  color: #fff;
  transform: scale(1.05);
}

.product-info {
  background: #fff;
  padding: 0.6rem 0.95rem 0.9rem;
  text-align: center;
  margin-top: auto;
}

.product-name {
  font-size: 1rem;
  font-weight: 600;
  color: #1f1f1f;
  margin-bottom: 0.3rem;
  min-height: 2.4rem;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.product-price {
  font-size: 0.95rem;
  color: #5d5d5d;
  margin: 0;
  font-weight: 600;
}
</style>

<main class="container py-5">
  <div class="row">
    <!-- Filter Sidebar -->
    <div class="col-lg-3 col-md-4 mb-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-4">Filter Products</h5>
          
          <!-- Price Range Filter -->
          <div class="mb-4">
            <h6 class="mb-3 fw-bold">Price Range (EGP)</h6>
            <div class="form-check mb-2">
              <input class="form-check-input price-filter" type="radio" name="priceRange" id="price-all" value="all" checked>
              <label class="form-check-label" for="price-all">All Prices</label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input price-filter" type="radio" name="priceRange" id="price-0-500" value="0-500">
              <label class="form-check-label" for="price-0-500">EGP 0 - 500</label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input price-filter" type="radio" name="priceRange" id="price-500-1500" value="500-1500">
              <label class="form-check-label" for="price-500-1500">EGP 500 - 1,500</label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input price-filter" type="radio" name="priceRange" id="price-1500-3000" value="1500-3000">
              <label class="form-check-label" for="price-1500-3000">EGP 1,500 - 3,000</label>
            </div>
            <div class="form-check">
              <input class="form-check-input price-filter" type="radio" name="priceRange" id="price-3000" value="3000+">
              <label class="form-check-label" for="price-3000">EGP 3,000+</label>
            </div>
          </div>
          
          <!-- Rating Filter -->
          <div class="mb-4">
            <h6 class="mb-3 fw-bold">Minimum Rating</h6>
            <select id="rating-filter" class="form-select">
              <option value="0">Any Rating</option>
              <option value="3">3+ Stars</option>
              <option value="4">4+ Stars</option>
              <option value="5">5 Stars Only</option>
            </select>
          </div>
          
          <!-- Sort By -->
          <div class="mb-4">
            <h6 class="mb-3 fw-bold">Sort By</h6>
            <select id="sort-by" class="form-select">
              <option value="default">Default</option>
              <option value="price-asc">Price: Low to High</option>
              <option value="price-desc">Price: High to Low</option>
              <option value="name-asc">Name: A to Z</option>
              <option value="name-desc">Name: Z to A</option>
              <option value="rating-desc">Highest Rating</option>
            </select>
          </div>
          
          <button id="reset-filters" class="btn btn-outline-primary w-100 mb-4">
            Reset Filters
          </button>
          
          <!-- Category Filter -->
          <div class="mb-2">
            <h6 class="mb-3 fw-bold">Categories</h6>
            <div class="nav flex-column">
              <button class="nav-link text-start active category-filter" data-cat="">
                All Categories
              </button>
              <button class="nav-link text-start category-filter" data-cat="jackets">Jackets</button>
              <button class="nav-link text-start category-filter" data-cat="hoodies">Hoodies</button>
              <button class="nav-link text-start category-filter" data-cat="pants">Pants</button>
              {% for c in categories %}
                {% if c.catName|lower not in ['jackets', 'hoodies', 'pants'] %}
                  <button class="nav-link text-start category-filter" data-cat="{{ c.catName|lower }}">
                    {{ c.catName }}
                  </button>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="col-lg-9 col-md-8">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">All Products</h2>
        <small class="text-muted" id="product-count">0 products found</small>
      </div>
      
      <!-- Products will be loaded via AJAX -->
      <div id="all-products" class="row g-3">
        <div class="col-12 text-center py-5">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading products...</span>
          </div>
          <p class="mt-3 text-muted">Loading products...</p>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
// --- Helper to set filters from query params ---
function setFiltersFromQuery() {
  const params = new URLSearchParams(window.location.search);
  const category = params.get('category') || '';
  const price = params.get('price') || 'all';
  const rating = params.get('rating') || '0';
  const sort = params.get('sort') || 'default';

  // Set category
  document.querySelectorAll('.category-filter').forEach(btn => {
    if ((btn.dataset.cat || '') === category) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
  // Set price
  const priceInput = document.querySelector(`.price-filter[value="${price}"]`);
  if (priceInput) priceInput.checked = true;
  // Set rating
  document.getElementById('rating-filter').value = rating;
  // Set sort
  document.getElementById('sort-by').value = sort;
}

// --- On page load, set filters from query and trigger AJAX ---
document.addEventListener('DOMContentLoaded', function() {
  setFiltersFromQuery();
  // Load products via AJAX only
  updateProducts();
});

// Function to update products via AJAX
function updateProducts() {
  const params = new URLSearchParams();
  const activeCat = document.querySelector('.category-filter.active')?.dataset.cat;
  const price = document.querySelector('.price-filter:checked')?.value;
  const rating = document.getElementById('rating-filter')?.value;
  const sort = document.getElementById('sort-by')?.value;

  if (activeCat) params.set('category', activeCat);
  if (price && price !== 'all') params.set('price', price);
  if (rating && rating !== '0') params.set('rating', rating);
  if (sort && sort !== 'default') params.set('sort', sort);

  // Show loading state
  document.getElementById('all-products').innerHTML = '<div class="col-12 text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';

  // Make AJAX request
  fetch('/shop.html?' + params.toString(), {
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    // Update product count
    document.getElementById('product-count').textContent = `${data.count} products found`;

    // Check if no products
    if (data.products.length === 0) {
      document.getElementById('all-products').innerHTML = '<div class="col-12 text-center py-5"><p class="text-muted">No products found</p></div>';
      return;
    }

    // Update products with SMALLER card design
    const productsHtml = data.products.map(product => {
      let imgSrc = product.image.startsWith('http') ? product.image :
                   (product.image.startsWith('/static/') ? product.image : '/static/uploads/' + product.image);
      const productId = product.id || product.pID;
      return `
        <div class="col-lg-3 col-md-4 col-6 product-item">
          <div class="product-card position-relative" onclick="window.location.href='/product/${productId}.html'" style="cursor:pointer;">
            <div class="product-image-wrapper">
              <img src="${imgSrc}" class="product-image" alt="${product.name}" onerror="this.onerror=null;this.src='/static/img/default.jpg';">
              <button class="favorite-btn" onclick="event.stopPropagation();">
                <i class="far fa-heart"></i>
              </button>
            </div>
            <div class="product-info">
              <h6 class="product-name">${product.name}</h6>
              <p class="product-price">EGP ${product.price.toFixed(2)}</p>
            </div>
          </div>
        </div>
      `;
    }).join('');

    document.getElementById('all-products').innerHTML = productsHtml;
  })
  .catch(error => {
    console.error('Error:', error);
    document.getElementById('all-products').innerHTML = '<div class="col-12 text-center text-danger">Error loading products. Please try again.</div>';
  });
}

// Attach to filter events
document.querySelectorAll('.category-filter').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    updateProducts();
  });
});

document.querySelectorAll('.price-filter').forEach(btn => {
  btn.addEventListener('change', updateProducts);
});

document.getElementById('rating-filter').addEventListener('change', updateProducts);
document.getElementById('sort-by').addEventListener('change', updateProducts);

document.getElementById('reset-filters').addEventListener('click', function() {
  // Reset all filters
  document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
  document.querySelector('.category-filter[data-cat=""]').classList.add('active');
  document.getElementById('price-all').checked = true;
  document.getElementById('rating-filter').value = '0';
  document.getElementById('sort-by').value = 'default';
  
  // Update products
  updateProducts();
});
</script>

<style>
/* Product Card Styling - Smaller, Cleaner Design */
.product-card {
  background: #f5f5f5;
  border-radius: 8px;
  overflow: hidden;
  transition: transform 0.2s ease;
  margin-bottom: 1.5rem;
}

.product-card:hover {
  transform: translateY(-3px);
}

.product-image-wrapper {
  position: relative;
  background: #f5f5f5;
  padding: 1rem;
  aspect-ratio: 3/4;
  display: flex;
  align-items: center;
  justify-content: center;
}

.product-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.product-card:hover .product-image {
  transform: scale(1.05);
}

.favorite-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background: white;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  z-index: 10;
}

.favorite-btn:hover {
  background: #ff6b6b;
  color: white;
}

.favorite-btn:hover i {
  transform: scale(1.1);
}

.product-info {
  background: white;
  padding: 0.75rem 1rem;
  text-align: center;
}

.product-name {
  font-size: 0.95rem;
  font-weight: 600;
  margin: 0 0 0.5rem 0;
  color: #222;
  min-height: 2.5rem;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.product-price {
  font-size: 0.9rem;
  color: #666;
  margin: 0;
  font-weight: 500;
}

/* Loading Spinner */
.spinner-border {
  width: 3rem;
  height: 3rem;
  border-width: 0.3em;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .product-item {
    margin-bottom: 1rem;
  }
  
  .product-name {
    font-size: 0.85rem;
    min-height: 2rem;
  }
  
  .product-price {
    font-size: 0.85rem;
  }
}

@media (max-width: 576px) {
  .product-image-wrapper {
    padding: 0.5rem;
  }
  
  .favorite-btn {
    width: 32px;
    height: 32px;
    font-size: 0.85rem;
  }
}
</style>

{% endblock %}
